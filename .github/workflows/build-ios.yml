name: Build iOS App

on:
  push:
    branches: [main]

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        npm install
        npm install @capacitor/ios
        
    - name: Prepare web app
      run: |
        # Créer le dossier www s'il n'existe pas
        mkdir -p www
        
    - name: Build iOS project
      run: |
        npx cap add ios
        npx cap sync ios
        
    - name: Create IPA file
      run: |
        cd ios/App
        # Créer une structure d'application iOS simple
        mkdir -p Payload/App.app
        echo '<?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleDisplayName</key>
            <string>Mon Tracker</string>
            <key>CFBundleIdentifier</key>
            <string>com.ethan.tracker</string>
            <key>CFBundleVersion</key>
            <string>1.0</string>
            <key>CFBundleExecutable</key>
            <string>App</string>
            <key>UILaunchStoryboardName</key>
            <string>LaunchScreen</string>
        </dict>
        </plist>' > Payload/App.app/Info.plist
        
        # Copier les fichiers web
        cp -r ../../www/* Payload/App.app/
        
        # Créer l'IPA
        zip -qr MonTracker.ipa Payload
        
    - name: Upload IPA
      uses: actions/upload-artifact@v3
      with:
        name: iOS-App
        path: ios/App/MonTracker.ipa
